erofs合并镜像时先从高层镜像开始处理，依次将没有加入mergedir的结点加入mergedir
如果发现有重复的目录，则合并目录。如果重复目录有opaque标记，则跳过这个目录。但如果第一个镜像中的目录没有opaque，中间镜像的目录有，中间镜像的目录的opaque就不会被处理，导致这个中间镜像下次镜像中的同名目录，预期会被跳过，但实际会被合并

# 复现流程
归档阈值设置为100M
写入文件每个为60M

[root@fedora random_files]# ls src/
random_file01  random_file03  random_file05  random_file07  random_file09
random_file02  random_file04  random_file06  random_file08
[root@fedora random_files]#

1、将包含9个文件的目录写入
cp -a src/ /mnt/fuse_dir/

[root@fedora random_files]# ls /mnt/fuse_dir/
[root@fedora random_files]# cp -a src/ /mnt/fuse_dir/
cp: preserving times for '/mnt/fuse_dir/src/random_file01': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file02': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file03': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file04': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file05': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file06': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file07': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file08': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src/random_file09': Function not implemented
cp: preserving times for '/mnt/fuse_dir/src': Function not implemented
[root@fedora random_files]# ls /mnt/fuse_dir/src/
random_file01  random_file03  random_file05  random_file07  random_file09
random_file02  random_file04  random_file06  random_file08
[root@fedora random_files]# ls /mnt/sdd/overlay_dir/
57adc027-a6de-4587-b759-c24d6e5a2f6c/ tmp/
[root@fedora random_files]# ls /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/ovl/
arc_00_04  dir_05  merge  work
[root@fedora random_files]#

2、整个目录删除
rm -rf /mnt/fuse_dir/src/

3、新建目录
mkdir /mnt/fuse_dir/src

4、向目录中依次拷贝文件
[root@fedora random_files]# cp random_file01 /mnt/fuse_dir/src/
[root@fedora random_files]# cp random_file09 /mnt/fuse_dir/src/
[root@fedora random_files]# ls /mnt/fuse_dir/src/
random_file01  random_file09
[root@fedora random_files]# cp random_file02 /mnt/fuse_dir/src/
[root@fedora random_files]# cp random_file03 /mnt/fuse_dir/src/
[root@fedora random_files]# cp random_file04 /mnt/fuse_dir/src/
[root@fedora random_files]# cp random_file05 /mnt/fuse_dir/src/
[root@fedora random_files]# ls /mnt/fuse_dir/src/
random_file01  random_file02  random_file03  random_file04  random_file05  random_file09
[root@fedora random_files]# cp random_file06 /mnt/fuse_dir/src/
[root@fedora random_files]# ls /mnt/fuse_dir/src/
random_file01  random_file03  random_file05  random_file07  random_file09
random_file02  random_file04  random_file06  random_file08
[root@fedora random_files]#
拷贝完 random_file06 后多出了 random_file07 和 random_file08



inode->opaque

liberofs_merge
 cfg.c_img_path = strdup(opt->base_meta);
 cfg.c_src_path = strdup(opt->inc_meta_vec[0]);
 rebuild_mode = true
 import_rebuild_src
  erofs_dev_open
  list_add // 将 erofs_sb_info 加入 rebuild_src_list 链表
 erofs_mkfs
  erofs_rebuild_make_root // 分配一个 root inode ，作为 mergedir ，目标根节点
  erofs_mkfs_rebuild_load_trees // rebuild_mode
   // 遍历 rebuild_src_list 链表上的所有镜像
   erofs_rebuild_load_tree
    erofs_read_superblock // 读取超级块 erofs_super_block
    erofs_read_inode_from_disk // 根据 nid 计算当前镜像的 root inode 在镜像中的位置并读取， nid 来源于 super block 中的 root_nid
	erofs_iterate_dir // 基于 root inode 遍历目录树，循环 遍历完 dir->i_size 大小范围
	 erofs_pread // 读一个 block
	 traverse_dirents // 循环 遍历完当前 block 范围内的子目录
	  erofs_rebuild_dirent_iter // ctx->cb 												处理需要合并的镜像中的文件
	   erofs_rebuild_get_dentry
	    erofs_d_lookup // 从父节点的 i_subdirs 链表中查找
	    erofs_rebuild_mkdir // 对于目录，在父节点的 i_subdirs 链表中找不到的情况
	     erofs_new_inode // 分配新的 erofs_inode 并初始化
		 erofs_d_alloc // 分配一个新的 erofs_dentry 插入父节点的 i_subdirs 链表
		 d->type = EROFS_FT_DIR // 设置 erofs_dentry 类型
		 d->inode = inode // 关联 erofs_dentry 和 erofs_inode
	   erofs_read_xattrs_from_disk
	    erofs_listxattr // 获取文件扩展属性
		inode->opaque = true // 如果有 OVL_XATTR_OPAQUE 则设置 inode->opaque
	   d->inode = inode // 关联 erofs_dentry 和 erofs_inode
	   if (!S_ISDIR(d->inode->i_mode) || d->inode->opaque) // 当前 inode 是有 opaque 属性的目录，则跳过下层子目录的遍历
														   // 应该跳过下层镜像的遍历？
  erofs_rebuild_dump_tree
   erofs_mkfs_build_tree
    __erofs_mkfs_build_tree
	 erofs_mkfs_dump_tree
	  erofs_rebuild_handle_inode
	   erofs_rebuild_load_basedir
	    erofs_read_inode_from_disk
		erofs_iterate_dir
		 traverse_dirents
		  erofs_rebuild_basedir_dirent_iter // ctx->cb									处理基础镜像中的文件
		   erofs_rebuild_get_dentry
		    erofs_d_alloc // 直接插入
	  erofs_mkfs_go
  erofs_rebuild_cleanup
   list_del // 将 erofs_sb_info 从 rebuild_src_list 链表中移除

整个复现过程包含两次镜像合并：
1、meta.00~meta.04合并成meta.00_04
2、meta.00_04和meta.05~meta.08合并成meta.00_08
问题发生在第二次镜像合并时
	Line 351: [2025-09-18 17:08:00]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.04
	Line 419: [2025-09-18 17:08:00]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.03
	Line 454: [2025-09-18 17:08:00]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.02
	Line 509: [2025-09-18 17:08:01]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.01
	Line 1041: [2025-09-18 17:10:53]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.08
	Line 1104: [2025-09-18 17:10:53]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.07
	Line 1159: [2025-09-18 17:10:53]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.06
	Line 1194: [2025-09-18 17:10:53]  <D> erofs: erofs_mkfs_rebuild_load_trees() Line[1218] load tree from /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.05

erofs合并镜像时先从高层的待合并镜像开始处理，依次将没有加入mergedir的结点加入mergedir的i_subdirs链表中，最后处理base镜像。
如图中依次处理meta.08~meta.05
	Line 1046: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src
	Line 1049: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.08
	Line 1058: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file04
	Line 1061: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.08
	Line 1078: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file05
	Line 1081: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.08
	Line 1099: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file06
	Line 1102: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.08
	Line 1109: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src
	Line 1111: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[342] got src opaque 0
	Line 1112: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[348] got src opaque 0
	Line 1117: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file02
	Line 1120: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.07
	Line 1137: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file03
	Line 1140: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.07
	Line 1157: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file04
	Line 1164: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src
	Line 1166: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[342] got src opaque 0
	Line 1167: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[348] got src opaque 0
	Line 1172: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file02
	Line 1175: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file09
	Line 1178: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.06
	Line 1199: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src
	Line 1201: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[342] got src opaque 0
	Line 1203: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[348] got src opaque 1
	Line 1208: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file01
	Line 1211: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[364] new inode from sb /mnt/sdd/overlay_dir/57adc027-a6de-4587-b759-c24d6e5a2f6c/cache/0/meta.05
	Line 1228: [2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_dirent_iter() Line[314] parsing //src/random_file09

在遍历镜像文件(目录)的过程中，如果i_subdirs中没有该文件(目录)，则新生成结点插入(src目录在遍历meta.08时插入，其他文件在遍历后续镜像时插入)
	Line 1036: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add . to root
	Line 1038: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add .. to root
	Line 1047: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add src to root
	Line 1050: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add . to root
	Line 1052: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add .. to root
	Line 1059: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file04 to root
	Line 1079: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file05 to root
	Line 1100: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file06 to root
	Line 1118: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file02 to root
	Line 1138: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file03 to root
	Line 1176: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file09 to root
	Line 1209: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file01 to root
	Line 1265: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file07 to root
	Line 1269: [2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file08 to root
如果发现有重复的目录，且已有的目录结点没有opaque，则合并目录(erofs_rebuild_dirent_iter中的逻辑实现)

在处理meta.08时生成src结点插入链表，由于meta.08中src目录没有opaque属性，则插入结点的链表也没有该属性，后续所有同名目录都会被合并

在处理meta.05时，发现已有src结点，会直接进行合并操作，虽然meta.05中src目录有opaque属性，用于屏蔽下层镜像中的同名目录，但这个属性并不会被读取，这就导致最后在合并base镜像时会将镜像中的src目录进行合并

如图在处理最后base镜像时，由于检查到src目录并没有opaque属性，因此会遍历base镜像中src目录的所有文件，其中randomfile_06和random_file07在上层镜像中都没有，这里就会生成新的结点插入。
但我们的预期是meta.05中的src结点所携带的opaque属性会在遍历meta.05后续镜像时被设置在mergedir中的src结点上，从而在处理base镜像时直接跳过base镜像中的src目录
[2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_get_dentry() Line[126] got random_file05 opaque 0
[2025-09-18 17:10:53]  <D> erofs: traverse_dirents() Line[49] traversed nid (176) random_file06
[2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_basedir_dirent_iter() Line[500] ctx->dname random_file06random_file07random_file08random_file09
[2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_get_dentry() Line[126] got random_file06 opaque 0
[2025-09-18 17:10:53]  <D> erofs: traverse_dirents() Line[49] traversed nid (185) random_file07
[2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_basedir_dirent_iter() Line[500] ctx->dname random_file07random_file08random_file09
[2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file07 to root
[2025-09-18 17:10:53]  
[2025-09-18 17:10:53]  <D> erofs: traverse_dirents() Line[49] traversed nid (194) random_file08
[2025-09-18 17:10:53]  <D> erofs: erofs_rebuild_basedir_dirent_iter() Line[500] ctx->dname random_file08random_file09
[2025-09-18 17:10:53]  <D> erofs: erofs_d_alloc() Line[189] add random_file08 to root
[2025-09-18 17:10:53]  
[2025-09-18 17:10:53]  <D> erofs: traverse_dirents() Line[49] traversed nid (201) random_file09
